env:
  contexts:
    - name: juice-shop-context
      urls:
        - https://juice-shop.herokuapp.com
      includePaths:
        - https://juice-shop.herokuapp.com/.*

      # ğŸ” Script-based authentication (fail hard)
      authentication:
        method: script
        parameters:
          script: juice-shop-auth

      sessionManagement:
        method: cookie

      users:
        - name: admin-user
          credentials:
            username: admin@juice-sh.op
            password: admin123

# ğŸ“œ REGISTER THE SCRIPT (THIS WAS MISSING)
scripts:
  - name: juice-shop-auth
    type: authentication
    engine: ECMAScript
    file: .github/workflows/zap/scripts/juice-shop-auth.js

jobs:
  # ğŸ•· Authenticated spider
  - type: spider
    parameters:
      context: juice-shop-context
      user: admin-user
      maxDuration: 5

  # ğŸ”¥ Authenticated active scan
  - type: activeScan
    parameters:
      context: juice-shop-context
      user: admin-user
      maxScanDurationInMins: 5

  # ğŸ“„ Reports
  - type: report
    parameters:
      template: traditional-html
      reportDir: .
      reportFile: report_html.html

  - type: report
    parameters:
      template: traditional-json
      reportDir: .
      reportFile: report_json.json

  - type: report
    parameters:
      template: traditional-md
      reportDir: .
      reportFile: report_md.md
